-- Run as pizzeria_user
-- ALTER DATABASE OPEN;
-- alter pluggable database orclpdb open;

-- ========== a. STANDARD AUDITING
-- Enable Standard Audit for Sensitive Tables
-- Audit all DML operations on PLATE table (prices are sensitive)
AUDIT INSERT, UPDATE, DELETE ON PLATE;

-- Audit all DML operations on EMPLOYEE table (personal data)
AUDIT INSERT, UPDATE, DELETE ON EMPLOYEE;

-- Audit all DML operations on OWNER table (owner information)
AUDIT INSERT, UPDATE, DELETE ON OWNER;

-- Audit all DML operations on PIZZERIA table (business data)
AUDIT INSERT, UPDATE, DELETE ON PIZZERIA;

-- Audit all DML operations on MENU table
AUDIT INSERT, UPDATE, DELETE ON MENU;


-- Verify Audits are Enabled
-- Show the main DML operations
SELECT object_name, sel, ins, upd, del
FROM user_obj_audit_opts
WHERE object_name IN ('PLATE', 'EMPLOYEE', 'OWNER', 'MENU', 'PIZZERIA');

-- Perform Operations to Generate Audit Trail
-- Update plate prices
UPDATE PLATE 
SET price = 12.99 
WHERE plate_id = 1;

-- Insert new employee
INSERT INTO EMPLOYEE (employee_id, name, age, gender, team_id)
VALUES (100, 'Test Employee', 30, 'M', 1);

-- Delete test employee
DELETE FROM EMPLOYEE WHERE employee_id = 100;

-- Update owner information
UPDATE OWNER 
SET name = 'Giovanni Rossi Updated'
WHERE owner_id = 1;

-- Rollback changes
ROLLBACK;


-- View Audit Trail
-- View recent audit records
SELECT username, obj_name, action_name,
       TO_CHAR(timestamp, 'YYYY-MM-DD HH24:MI:SS') as audit_time,
       SUBSTR(sql_text, 1, 80) as sql_snippet
FROM user_audit_trail
WHERE obj_name IN ('PLATE', 'EMPLOYEE', 'OWNER', 'MENU', 'PIZZERIA')
ORDER BY timestamp DESC
FETCH FIRST 20 ROWS ONLY;

-- Count operations by table
SELECT obj_name, action_name, COUNT(*) as operation_count
FROM user_audit_trail
WHERE obj_name IN ('PLATE', 'EMPLOYEE', 'OWNER', 'MENU', 'PIZZERIA')
GROUP BY obj_name, action_name
ORDER BY obj_name, operation_count DESC;

-- Stop Standard Auditing
NOAUDIT INSERT, UPDATE, DELETE ON PLATE;
NOAUDIT INSERT, UPDATE, DELETE ON EMPLOYEE;
NOAUDIT INSERT, UPDATE, DELETE ON OWNER;
NOAUDIT INSERT, UPDATE, DELETE ON PIZZERIA;
NOAUDIT INSERT, UPDATE, DELETE ON MENU;

-- ========== b. AUDIT TRIGGERS
-- Run as PIZZERIA_USER

-- Create Audit Infrastructure
-- Create sequence for audit IDs
CREATE SEQUENCE seq_audit_pizzeria START WITH 1 INCREMENT BY 1;

-- Create audit table
CREATE TABLE audit_historic (
    id_audit NUMBER PRIMARY KEY,
    user_ VARCHAR2(30),
    session_ NUMBER(10),
    host_ VARCHAR2(100),
    time_ DATE,
    table_name VARCHAR2(30),
    operation VARCHAR2(20),
    old_value VARCHAR2(500),
    new_value VARCHAR2(500)
);

-- Create Audit Trigger
-- Audit PLATE price changes
CREATE OR REPLACE TRIGGER audit_trigger_plate_price
AFTER UPDATE OF price ON PLATE
FOR EACH ROW
BEGIN
    INSERT INTO audit_historic VALUES (
        seq_audit_pizzeria.NEXTVAL,
        SYS_CONTEXT('USERENV', 'SESSION_USER'),
        SYS_CONTEXT('USERENV', 'SESSIONID'),
        SYS_CONTEXT('USERENV', 'HOST'),
        SYSDATE,
        'PLATE',
        'UPDATE PRICE',
        'Plate: ' || :OLD.name || ', Old Price: ' || :OLD.price,
        'Plate: ' || :NEW.name || ', New Price: ' || :NEW.price
    );
END;

-- Test Audit Trigger
-- Update plate price
UPDATE PLATE 
SET price = 11.50 
WHERE plate_id = 2;

COMMIT;

-- View Trigger Audit Results
-- View all audit records
SELECT id_audit, user_, table_name, operation,
       TO_CHAR(time_, 'YYYY-MM-DD HH24:MI:SS') as audit_time,
       SUBSTR(old_value, 1, 50) as old_val,
       SUBSTR(new_value, 1, 50) as new_val
FROM audit_historic
ORDER BY time_ DESC;

-- Count operations by table
SELECT table_name, operation, COUNT(*) as count
FROM audit_historic
GROUP BY table_name, operation
ORDER BY table_name, count DESC;

-- View operations by specific user
SELECT user_, table_name, COUNT(*) as operations
FROM audit_historic
GROUP BY user_, table_name
ORDER BY operations DESC;

-- Rollback test changes
ROLLBACK;

-- Clean up test data
DELETE FROM MENU WHERE menu_id = 200;
DELETE FROM EMPLOYEE WHERE employee_id = 200;
COMMIT;

-- ========== c. AUDIT POLICIES
-- Run as PIZZERIA_USER

-- Create Audit Handler
-- Handler procedure that executes when policy is triggered
CREATE OR REPLACE PROCEDURE audit_handler_plate(
    object_schema VARCHAR2,
    object_name VARCHAR2,
    policy_name VARCHAR2
) AS
BEGIN
    DBMS_OUTPUT.PUT_LINE('Audit Policy Triggered: ' || policy_name);
    DBMS_OUTPUT.PUT_LINE('Schema: ' || object_schema || ', Object: ' || object_name);
END;
/

-- Create Audit Policies
-- Policy 1: Audit price changes on PLATE table
BEGIN
    DBMS_FGA.ADD_POLICY(
        object_schema   => USER,
        object_name     => 'PLATE',
        policy_name     => 'policy_plate_price',
        enable          => FALSE,  -- Start disabled, will enable later
        statement_types => 'UPDATE',
        audit_column    => 'PRICE',
        handler_module  => 'AUDIT_HANDLER_PLATE'
    );
END;
/

-- Policy 2: Audit employee data access
BEGIN
    DBMS_FGA.ADD_POLICY(
        object_schema   => USER,
        object_name     => 'EMPLOYEE',
        policy_name     => 'policy_employee_access',
        enable          => FALSE,
        statement_types => 'SELECT, UPDATE',
        audit_column    => 'NAME, AGE'
    );
END;
/

-- Policy 3: Audit PIZZERIA ownership queries
BEGIN
    DBMS_FGA.ADD_POLICY(
        object_schema   => USER,
        object_name     => 'PIZZERIA',
        policy_name     => 'policy_pizzeria_owner',
        enable          => FALSE,
        statement_types => 'SELECT, UPDATE',
        audit_column    => 'OWNER_ID'
    );
END;
/

-- Enable Audit Policies
-- Enable policy for PLATE
BEGIN
    DBMS_FGA.ENABLE_POLICY(
        object_schema => USER,
        object_name   => 'PLATE',
        policy_name   => 'policy_plate_price'
    );
END;
/

-- Enable policy for EMPLOYEE
BEGIN
    DBMS_FGA.ENABLE_POLICY(
        object_schema => USER,
        object_name   => 'EMPLOYEE',
        policy_name   => 'policy_employee_access'
    );
END;
/

-- Enable policy for PIZZERIA
BEGIN
    DBMS_FGA.ENABLE_POLICY(
        object_schema => USER,
        object_name   => 'PIZZERIA',
        policy_name   => 'policy_pizzeria_owner'
    );
END;
/

-- Verify Policies are Enabled
-- View all enabled policies
SELECT object_name, policy_name, enabled, sel, ins, upd, del
FROM user_audit_policies
ORDER BY object_name, policy_name;

-- Check if DBMS_FGA package is accessible
SELECT object_name, object_type, status
FROM user_objects
WHERE object_name LIKE 'AUDIT%'
  AND object_type IN ('PROCEDURE', 'FUNCTION');

-- Test Audit Policies
-- Test 1: Query employee data (triggers policy_employee_access)
SELECT name, age FROM EMPLOYEE WHERE employee_id = 1;

-- Test 2: Update plate price (triggers policy_plate_price)
UPDATE PLATE SET price = 13.99 WHERE plate_id = 3;

-- Test 3: Query pizzeria ownership (triggers policy_pizzeria_owner)
SELECT name, owner_id FROM PIZZERIA WHERE pizzeria_id = 1;

COMMIT;

-- View Fine-Grained Audit Results
-- View FGA audit trail
SELECT db_user, object_name, policy_name,
       TO_CHAR(timestamp, 'YYYY-MM-DD HH24:MI:SS') as access_time,
       SUBSTR(sql_text, 1, 100) as sql_snippet
FROM dba_fga_audit_trail
WHERE db_user = USER
  AND object_name IN ('PLATE', 'EMPLOYEE', 'PIZZERIA', 'MENU')
ORDER BY timestamp DESC;

-- Count accesses by policy
SELECT policy_name, object_name, COUNT(*) as access_count
FROM dba_fga_audit_trail
WHERE db_user = USER
  AND object_name IN ('PLATE', 'EMPLOYEE', 'PIZZERIA', 'MENU')
GROUP BY policy_name, object_name
ORDER BY access_count DESC;

-- Rollback test changes
ROLLBACK;
DELETE FROM MENU WHERE menu_id = 300;
COMMIT;

-- Disable Policies
BEGIN
    DBMS_FGA.DISABLE_POLICY(
        object_schema => USER,
        object_name   => 'PLATE',
        policy_name   => 'policy_plate_price'
    );
    
    DBMS_FGA.DISABLE_POLICY(
        object_schema => USER,
        object_name   => 'EMPLOYEE',
        policy_name   => 'policy_employee_access'
    );
    
    DBMS_FGA.DISABLE_POLICY(
        object_schema => USER,
        object_name   => 'PIZZERIA',
        policy_name   => 'policy_pizzeria_owner'
    );
    
    DBMS_FGA.DISABLE_POLICY(
        object_schema => USER,
        object_name   => 'MENU',
        policy_name   => 'policy_menu_insert'
    );
END;
/